#!/usr/bin/env lua5.4

lambert=require 'lambert93'

-- random samples from BAN database, accurate for continental France only.
testdata={
{lat=48.868323,lon=7.181552,x=1006603.74,y=6871264.02},
{lat=48.224209,lon=-3.180663,x=241467.54,y=6809494.72},
{lat=46.606504,lon=0.358847,x=497883.95,y=6615208.5},
{lat=44.606973,lon=4.386083,x=809983.12,y=6390730.09},
{lat=50.653273,lon=3.147136,x=710423.28,y=7061827.3},
{lat=50.375338,lon=2.230994,x=645222.01,y=7031119.47},
{lat=47.470717,lon=6.639425,x=974040.18,y=6714134.05},
{lat=46.464428,lon=-0.815581,x=407307.08,y=6603122.59},
{lat=48.972087,lon=-0.5365,x=441175.48,y=6880479.51},
{lat=45.419357,lon=4.402617,x=809692.28,y=6480966.76},
{lat=48.808384,lon=2.545676,x=666633.88,y=6856575.01},
{lat=47.364627,lon=-2.187951,x=308728.43,y=6708890.55},
{lat=48.783062,lon=2.429178,x=658057.91,y=6853815.1},
{lat=49.088026,lon=6.908664,x=985402.77,y=6894641.66},
{lat=46.482359,lon=0.586481,x=514876.77,y=6600870.27},
{lat=43.199664,lon=1.012035,x=538330.56,y=6235418.08},
{lat=47.564571,lon=-2.063608,x=319516.67,y=6730447.83},
{lat=49.569165,lon=3.643009,x=746534.02,y=6941291},
{lat=50.028459,lon=3.263388,x=718890.82,y=6992254.99},
{lat=50.394313,lon=3.533609,x=737996.17,y=7033094.74},
{lat=48.919687,lon=2.475813,x=661585.29,y=6868982.96},
{lat=48.54126,lon=2.625895,x=672384.52,y=6826846.27},
{lat=49.033996,lon=2.466087,x=660958.49,y=6881699.44},
{lat=48.746837,lon=-0.011723,x=478606.81,y=6853858.4},
{lat=48.064496,lon=-0.821681,x=415438.6,y=6780678.32},
{lat=48.859471,lon=2.404043,x=656275.23,y=6862324.53},
{lat=43.312812,lon=2.910283,x=692717.37,y=6245965.51},
{lat=46.603191,lon=4.070585,x=781945.01,y=6612015.56},
{lat=46.896198,lon=6.346729,x=954718.57,y=6649400.61},
{lat=48.086035,lon=7.362817,x=1024683.6,y=6785156.3},
{lat=42.785432,lon=2.970469,x=697580.94,y=6187323.66},
{lat=50.653058,lon=3.025645,x=701816.73,y=7061793.93},
{lat=48.520955,lon=7.655932,x=1043624.29,y=6834657.3},
{lat=48.9236,lon=3.272538,x=719971.38,y=6869325.05},
{lat=43.35666,lon=3.528643,x=742878.79,y=6250979.12},
{lat=43.71544,lon=1.392953,x=570470.27,y=6292030.48},
{lat=45.856059,lon=4.354687,x=805112.3,y=6529390.84},
{lat=47.544925,lon=-2.694089,x=272062.18,y=6731497.77},
{lat=44.677382,lon=-1.008717,x=382432.9,y=6405648.41},
{lat=45.648273,lon=5.193826,x=870849.88,y=6507787.85},
{lat=47.216089,lon=3.428676,x=732443.13,y=6679620.66},
{lat=48.627074,lon=4.954126,x=843998.39,y=6838102.6},
{lat=50.515972,lon=3.155825,x=711069.01,y=7046530.2},
{lat=43.568743,lon=1.231477,x=557092.09,y=6276009.28},
{lat=48.969315,lon=2.383135,x=654836.68,y=6874550.69},
{lat=44.917278,lon=-0.242338,x=444200.43,y=6429483.9},
{lat=47.687672,lon=6.781872,x=983604.1,y=6738713.22},
{lat=48.439433,lon=2.554858,x=667076.99,y=6815554.48},
{lat=49.182169,lon=-0.360136,x=455068.93,y=6903259.58},
{lat=45.601261,lon=6.886132,x=1002816.19,y=6507646.6},
{lat=49.479741,lon=1.71724,x=607009.16,y=6931906.68},
{lat=50.239346,lon=3.442522,x=731607.03,y=7015794.78},
{lat=47.795748,lon=6.054122,x=928595.98,y=6748349.57},
{lat=48.812036,lon=2.371389,x=653837.5,y=6857068.84},
{lat=45.459251,lon=-0.447372,x=430661.57,y=6490303.28},
{lat=44.619671,lon=-0.920983,x=389059.14,y=6398896.92},
{lat=42.773916,lon=2.989937,x=699175.52,y=6186042.52},
{lat=46.344692,lon=4.930217,x=848434.69,y=6584566.7},
{lat=47.180453,lon=-1.587509,x=352771.15,y=6685663.63},
{lat=47.232076,lon=-0.502829,x=435062.72,y=6687185.76},
{lat=46.857925,lon=-1.942621,x=323685.67,y=6651532.5},
{lat=50.281364,lon=2.640745,x=674361.54,y=7020444.12},
{lat=45.824545,lon=4.956577,x=851892.51,y=6526871.45},
{lat=48.040305,lon=-2.988058,x=254180.34,y=6788014.83},
{lat=47.281907,lon=0.167262,x=485919.42,y=6690684.04},
{lat=44.843309,lon=0.888833,x=533195.94,y=6418245.71},
{lat=49.11891,lon=7.078518,x=997617.03,y=6898699.27},
{lat=50.173326,lon=3.23074,x=716502.1,y=7008378.15},
{lat=50.298443,lon=3.3498,x=724955.28,y=7022343.25},
{lat=49.238182,lon=6.420415,x=949052.48,y=6909672.87},
{lat=44.201744,lon=4.546069,x=823557.53,y=6345957.77},
{lat=46.097129,lon=-0.75761,x=409810.32,y=6562166.06},
{lat=43.192973,lon=2.764698,x=680860.07,y=6232667.53},
{lat=49.366201,lon=0.084397,x=488212.23,y=6922429.63},
{lat=43.551005,lon=5.045358,x=865324.33,y=6274578.71},
-- {lat=14.621783,lon=-61.014236,x=713892.69,y=1617430.15},  -- Martinica, another coding standard in BAN
{lat=46.118971,lon=3.431903,x=733353.82,y=6557776.87},
{lat=47.259847,lon=-2.42915,x=289765.78,y=6698501.79},
{lat=49.046047,lon=2.105725,x=634623.69,y=6883277.9},
{lat=48.438641,lon=2.167623,x=638436.7,y=6815698.13},
{lat=45.739992,lon=4.925183,x=849684.74,y=6517424.66},
{lat=49.227892,lon=-0.441167,x=449387.58,y=6908594.99},
{lat=47.699392,lon=-3.246142,x=232011.58,y=6751741.72},
{lat=45.881034,lon=2.173582,x=635903.98,y=6531598.06},
{lat=47.907887,lon=1.90236,x=617998.82,y=6756958.14},
{lat=48.752473,lon=2.4844,x=662093.17,y=6850386.18},
{lat=48.744088,lon=1.378524,x=580777.72,y=6850554.28},
{lat=43.664325,lon=3.937705,x=775650.94,y=6285480.94},
{lat=43.948188,lon=7.280003,x=1043426.58,y=6325885.76},
{lat=50.727129,lon=1.622511,x=602565.57,y=7070897.92},
{lat=49.595842,lon=3.655359,x=747403.12,y=6944266.78},
{lat=48.200015,lon=6.952909,x=993570.95,y=6796200.94},
{lat=46.249082,lon=1.479001,x=582825.46,y=6573263.22},
{lat=49.297323,lon=2.447207,x=659782.99,y=6910997.49},
{lat=48.609059,lon=7.59665,x=1038684.21,y=6844178.66},
{lat=43.763786,lon=7.474438,x=1060172.18,y=6306292.4},
{lat=46.13796,lon=5.900602,x=923873,y=6563906.73},
{lat=49.076228,lon=6.193875,x=933295.03,y=6890983.11},
{lat=48.795659,lon=2.472394,x=661242.59,y=6855193.62},
{lat=49.157711,lon=4.334955,x=797379.87,y=6896150.21}
}

local function m_per_deg_lat(phi)   -- phi в радианах
  return 111132.92 - 559.82*math.cos(2*phi) + 1.175*math.cos(4*phi)
end
local function m_per_deg_lon(phi)
  return 111412.84*math.cos(phi) - 93.5*math.cos(3*phi) + 0.118*math.cos(5*phi)
end

for _,v in pairs(testdata) do
  local lat, lon = lambert.xy2latlon(v.x, v.y)
  local x, y = lambert.latlon2xy(v.lat, v.lon)
  if lat ~= lat or lon ~= lon or x ~= x or y ~= y then
    print('got NAN for lat %s lon %s x %s y %s',v.lat,v.lon,v.x,v.y)
  end

  local err_geo=math.sqrt((lat-v.lat)^2+(lon-v.lon)^2)
  local err_lambert=math.sqrt((x-v.x)^2+(y-v.y)^2)
  print(err_geo,err_lambert)
  if err_geo>1e-6 or err_lambert>0.1 then
    print('lat',v.lat,lat)
    print('lon',v.lon,lon)
    print('x',v.x,x)
    print('y',v.y,y)
  end
end


print("All tests done.")


